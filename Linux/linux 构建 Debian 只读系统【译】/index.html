<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>linux 构建 Debian 只读系统【译】 - My Docs</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">My Docs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Git <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../Git/git add 选项/">Git add 选项</a>
</li>
                                    
<li >
    <a href="../../Git/git push 允许合并无关历史记录/">Git push 允许合并无关历史记录</a>
</li>
                                    
<li >
    <a href="../../Git/git 常用命令速查表/">Git 常用命令速查表</a>
</li>
                                    
<li >
    <a href="../../Git/git 设置和取消代理/">Git 设置和取消代理</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Home <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../Home/c++ 宏定义 #define 和常量 const 的区别/">C++ 宏定义 #define 和常量 const 的区别</a>
</li>
                                    
<li >
    <a href="../../Home/chrome 不同操作系统 chrome 扩展包存放位置/">Chrome 不同操作系统 chrome 扩展包存放位置</a>
</li>
                                    
<li >
    <a href="../../Home/dev test 破除依赖——模拟对象和存根/">Dev test 破除依赖——模拟对象和存根</a>
</li>
                                    
<li >
    <a href="../../Home/idea 一个物联网云平台架构/">Idea 一个物联网云平台架构</a>
</li>
                                    
<li >
    <a href="../../Home/markdown 在 markdown 代码块中插入链接/">Markdown 在 markdown 代码块中插入链接</a>
</li>
                                    
<li >
    <a href="../../Home/windows 安装 Windows Subsystem for Linux/">windows 安装 Windows Subsystem for Linux</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Linux <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../linux Raspberry Pi 串口通讯——安装并使用 Linux 原生工具测试 与 Nodejs SerialPort 开发的过程/">Orange Pi GPIO 串口通讯</a>
</li>
                                    
<li >
    <a href="../linux apt-get 异常修复/">Linux apt get 异常修复</a>
</li>
                                    
<li >
    <a href="../linux crontab 使用 shell 脚本设置定时任务/">Linux crontab 使用 shell 脚本设置定时任务</a>
</li>
                                    
<li >
    <a href="../linux crontab 用户配置文件的位置/">Linux crontab 用户配置文件的位置</a>
</li>
                                    
<li >
    <a href="../linux deepin 搜狗输入法不能输入中文 | 搜狗输入法重装/">Linux deepin 搜狗输入法不能输入中文 | 搜狗输入法重装</a>
</li>
                                    
<li >
    <a href="../linux error 117 Structure needs cleaning/">linux error 117 Structure needs cleaning</a>
</li>
                                    
<li >
    <a href="../linux error Warning, had trouble writing out superblocks/">linux error Warning, had trouble writing out superblocks</a>
</li>
                                    
<li >
    <a href="../linux error a start job is running for ／etc／rc.local Compatibility/">linux error a start job is running for ／etc／rc.local Compatibility</a>
</li>
                                    
<li >
    <a href="../linux error device is busy/">Linux error device is busy</a>
</li>
                                    
<li >
    <a href="../linux fdisk 使用 shell 分区/">Linux fdisk 使用 shell 分区</a>
</li>
                                    
<li >
    <a href="../linux here document 用法(cat << EOF)/">linux here document 用法(cat << EOF)</a>
</li>
                                    
<li >
    <a href="../linux raspberry-pi 在树莓派上安装 python 3.6/">Linux raspberry pi 在树莓派上安装 python 3.6</a>
</li>
                                    
<li >
    <a href="../linux sed 25个使用示例/">Linux sed 25个使用示例</a>
</li>
                                    
<li >
    <a href="../linux sed 删除匹配行后的某行/">Linux sed 删除匹配行后的某行</a>
</li>
                                    
<li >
    <a href="../linux sed 匹配行前或后追加/">Linux sed 匹配行前或后追加</a>
</li>
                                    
<li >
    <a href="../linux sed 读取文件的第某行/">Linux sed 读取文件的第某行</a>
</li>
                                    
<li >
    <a href="../linux sed,awk 避开美元符号($)/">Linux sed,awk 避开美元符号($)</a>
</li>
                                    
<li >
    <a href="../linux shell 捕捉 CTRL-C 等信号/">linux shell 捕捉 CTRL C 等信号</a>
</li>
                                    
<li >
    <a href="../linux shell 给点颜色输出/">Linux shell 给点颜色输出</a>
</li>
                                    
<li >
    <a href="../linux shell 获得日期和时间/">Linux shell 获得日期和时间</a>
</li>
                                    
<li >
    <a href="../linux shell 重定向输出到文件或设备/">Linux shell 重定向输出到文件或设备</a>
</li>
                                    
<li >
    <a href="../linux signal 信号列表/">Linux signal 信号列表</a>
</li>
                                    
<li >
    <a href="../linux ssh 一行登录（有暴露密码风险）/">Linux ssh 一行登录（有暴露密码风险）</a>
</li>
                                    
<li >
    <a href="../linux supervisor 服务启动失败：supervisor.sock no such file/">Linux supervisor 服务启动失败：supervisor.sock no such file</a>
</li>
                                    
<li >
    <a href="../linux 一键下载软件包及其依赖到指定位置/">Linux 一键下载软件包及其依赖到指定位置</a>
</li>
                                    
<li >
    <a href="../linux 不重启更新分区表/">Linux 不重启更新分区表</a>
</li>
                                    
<li >
    <a href="../linux 为什么只能分 4 个主分区，而且最好留一个 Extended 分区，以及扩展分区不能直接使用，必须分成 Logical 分区才能使用/">linux 为什么只能分 4 个主分区，而且最好留一个 Extended 分区，以及扩展分区不能直接使用，必须分成 Logical 分区才能使用</a>
</li>
                                    
<li >
    <a href="../linux 修改 swappiness 参数（交换空间）/">Linux 修改 swappiness 参数（交换空间）</a>
</li>
                                    
<li >
    <a href="../linux 修改时间/">Linux 修改时间</a>
</li>
                                    
<li >
    <a href="../linux 列出所有支持的文件系统类型/">Linux 列出所有支持的文件系统类型</a>
</li>
                                    
<li >
    <a href="../linux 创建和授权用户/">Linux 创建和授权用户</a>
</li>
                                    
<li >
    <a href="../linux 删除指定日期前的文件/">Linux 删除指定日期前的文件</a>
</li>
                                    
<li >
    <a href="../linux 字符串转整数或浮点数，整数与浮点数两两比较/">Linux 字符串转整数或浮点数，整数与浮点数两两比较</a>
</li>
                                    
<li >
    <a href="../linux 定时任务/">Linux 定时任务</a>
</li>
                                    
<li class="active">
    <a href="./">linux 构建 Debian 只读系统【译】</a>
</li>
                                    
<li >
    <a href="../linux 构建 Raspbian 只读文件系统/">linux 构建 Raspbian 只读文件系统</a>
</li>
                                    
<li >
    <a href="../linux 硬盘构造与分区/">Linux 硬盘构造与分区</a>
</li>
                                    
<li >
    <a href="../linux 磁盘分区实践/">Linux 磁盘分区实践</a>
</li>
                                    
<li >
    <a href="../linux 端口号 - 进程 ID - 进程名 互查/">linux 端口号   进程 ID   进程名 互查</a>
</li>
                                    
<li >
    <a href="../linux 系统备份与还原/">Linux 系统备份与还原</a>
</li>
                                    
<li >
    <a href="../linux 终端设置代理访问/">Linux 终端设置代理访问</a>
</li>
                                    
<li >
    <a href="../linux 解决 etc.network.interfaces dns-nameservers 没有同步到 etc.resolv.conf/">Linux 解决 etc.network.interfaces dns nameservers 没有同步到 etc.resolv.conf</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Mqtt <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../Mqtt/mqtt qos 机制/">Mqtt qos 机制</a>
</li>
                                    
<li >
    <a href="../../Mqtt/mqtt 应用实例 判断客户端是否下线/">Mqtt 应用实例 判断客户端是否下线</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Mysql <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../Mysql/mysql 停止运行的几种方式/">Mysql 停止运行的几种方式</a>
</li>
                                    
<li >
    <a href="../../Mysql/mysql 数据备份与还原/">Mysql 数据备份与还原</a>
</li>
                                    
<li >
    <a href="../../Mysql/mysql 数据等目录设置为其他目录（如外接硬盘下的目录）/">Mysql 数据等目录设置为其他目录（如外接硬盘下的目录）</a>
</li>
                                    
<li >
    <a href="../../Mysql/mysql 查看数据目录等的位置/">Mysql 查看数据目录等的位置</a>
</li>
                                    
<li >
    <a href="../../Mysql/mysql 注/">Mysql 注</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Nodejs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../Nodejs/nodejs express artTemplate 简明教程/">nodejs express artTemplate 简明教程</a>
</li>
                                    
<li >
    <a href="../../Nodejs/nodejs express 多种方案使用 session 与 cookie/">Nodejs express 多种方案使用 session 与 cookie</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Web <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../Web/web http cookie session 区别/">Web http cookie session 区别</a>
</li>
                                    
<li >
    <a href="../../Web/web http 关于 POST、PUT、PATCH 的区别/">web http 关于 POST、PUT、PATCH 的区别</a>
</li>
                                    
<li >
    <a href="../../Web/web http 关于 ssh/">Web http 关于 ssh</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../linux 定时任务/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../linux 构建 Raspbian 只读文件系统/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#debian">构建 Debian 只读系统</a></li>
            <li><a href="#_1">前提条件</a></li>
            <li><a href="#etc">/etc 目录下的特殊文件</a></li>
            <li><a href="#readonly-root">启用 readonly root</a></li>
            <li><a href="#readonly-root_1">系统安装过程中启用 readonly root</a></li>
            <li><a href="#_2">小贴士和小技巧</a></li>
            <li><a href="#aufs">AUFS 方式制作只读系统</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<blockquote>
<p><a href="https://wiki.debian.org/ReadonlyRoot#Enable_readonly_root">原文</a></p>
</blockquote>
<h1 id="debian">构建 Debian 只读系统</h1>
<p>文件层级结构标准（<a href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84%E6%A0%87%E5%87%86">FHS</a>）允许用户将部分文件系统挂接为只读。这样做带来了一些好处，比如系统启动时对文件系统所做的检查会更少，以及在系统崩溃时无需对整个文件系统进行检查。</p>
<h2 id="_1">前提条件</h2>
<p>FHS 允许将 <code>/bin</code>、<code>/lib</code>、<code>/sbin</code> 和 <code>/usr</code> 目录下所有子目录挂载为只读。但是你也可以对此做更进一步的扩展，即对各个子目录使用不同的文件系统，同时对一些特殊的文件予以特别的关照。</p>
<p>我们的只读系统中，有些目录是必须为可写的，它们是 <code>/etc</code>、<code>/home</code>、<code>/srv</code>、<code>/tmp</code>、<code>var</code>。而 <code>/dev</code> 目录下的子目录、<code>/proc</code>、<code>/selinux</code> 和 <code>/sys</code> 已经挂载为特殊的文件系统了。（译注：<code>/etc</code> 应该是部分可写，否则也不会有特别关照了）</p>
<p>对于 <code>/tmp</code>，你可以使用 tmpfs 文件系统，或者它自身的文件系统。而对于 <code>/var</code> 则应优先使用它自身的文件系统。下面是一个例子：</p>
<pre><code class="shell">Device file      Filesystem     Mount point     RO/RW ?
/dev/sda1        ext2           /               RO 
/dev/sda2        ext3           /var            RW
...              tmpfs          /tmp            RW
/var/local/home  bind mount     /home           RW
/var/local/srv   bind mount     /srv            RW
</code></pre>

<p>对根目录 <code>/</code> 你可以挂载为不带日志（journal）的文件系统，这是因为你不会往上面写东西，所以你也不需要日志。也可以将其挂载为 ext4，这样你就能充分利用 ext4 的改良特性。创建这样的文件系统可以使用 <code>mke2fs -t ext4 -0 ^has_journal /dev/sda1</code>，或者通过 <code>tune2fs -O ^has_journal /dev/sda1</code> 来为此文件系统移除日志。（译注：两个命令可以参考 <a href="https://www.google.com/search?ei=3FFYW5y5Kona8APSlKo4&amp;q=tune2fs+and+mke2fs&amp;oq=tune2fs+and+mke2fs&amp;gs_l=psy-ab.3...7610.15719.0.16972.12.12.0.0.0.0.642.2135.3-1j0j3.4.0....0...1c.1.64.psy-ab..8.2.990...0i203k1j0i30k1j0i8i30k1.0.9gCSlG1tgb8">google-search: tune2fs and mke2fs</a>。另外，你应该将系统盘挂载到其他 linux 系统上，运行上述两条指令中的一个，并且注意，第一个是格式化，第二个是调整参数）</p>
<p>（译注：<a href="https://unix.stackexchange.com/questions/198590/what-is-a-bind-mount">使用 bind mount</a>；<a href="https://serverfault.com/questions/613179/how-do-i-do-mount-bind-in-etc-fstab">在 <code>/etc/fstab</code> 中使用 bind mount</a>）</p>
<h2 id="etc"><code>/etc</code> 目录下的特殊文件</h2>
<p>在 <code>/etc</code> 目录下有些文件你必须特别关注。它们是：</p>
<h3 id="adjtime">adjtime</h3>
<p>系统启动时会对它进行修改。见 bug ~~<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=156489">156489</a>~~</p>
<p>解决方法：创建从 <code>/etc/adjtime</code> 到 <code>/var/local/adjtime</code> 的符号连接；同时：</p>
<ol>
<li>在 <code>/etc/init.d/hwclockfirst.sh</code> 和 <code>/etc/init.d/hwclock.sh</code> 中，将 <code>HWCLOCKPARS</code> 变量设置为 <code>--noadjfile</code>；或者
<br><br></li>
<li>修改 <code>/etc/init.d/hwclockfirst.sh</code>，将语句 <code>if [ -w /etc ] &amp;&amp; [ ! -f /etc/adjtime ] &amp;&amp; [ ! -e /etc/adjtime ]; then</code> 中的 <code>-f</code> 改为 <code>-L</code>，见 ~~<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=520606">520606</a>~~。</li>
</ol>
<h3 id="initdalsa-utils">init.d/alsa-utils</h3>
<p><a href="https://packages.debian.org/alsa-utils">alsa-utils</a> 在 alsa-utils/1.0.27.2-1 (@2013-10-25 兼容 wheezy) 之前的所有版本的启动脚本都会创建一个 <code>/.pulse</code> 文件，这就会导致当安装了 pulseaudio 时会多次出现错误信息 “Failed to create secure directory”。相关 bug <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=712980">712980</a>。</p>
<h3 id="blkidtab">blkid.tab</h3>
<p>系统运行时会通过<a href="https://packages.debian.org/search?keywords=libblkid1">libblkid1</a>对它进行修改。</p>
<p>解决方法：你不能创建一个从 <code>tc/blkid.tab</code> 到 <code>/var/local/blkid.tab</code> 的符号连接就了事，这是因为，很不幸的是，<a href="https://packages.debian.org/search?keywords=libblkid1">libblkid1</a> 会忽视这个符号连接。因为 libblkid1 在每次需要写入时，都会用一个文件将这个符号连接给替换掉，当然前提是文件系统挂载为可写（比如在 <code>apt-get install</code> 的时候）。绕过这个设定的办法是：将环境变量 <code>BLKID_FILE</code> 设置为 <code>/var/local/blkid.tab</code>。你应该到 <code>/etc/environment</code> 里面，为所有可能进行挂载操作的用户设置这个环境变量。</p>
<h3 id="courier-imap">courier imap</h3>
<p>Courier IMAP（译注：一种邮件系统，支持 IMAP 交互邮件访问协议）会使用一个文本文件（<code>/etc/courier/shared/index</code>）来提供快速的用户的检索，特别是作为一个邮件服务器提供虚拟邮箱服务时（不过针对 pam 的认证，其默认配置不受此影响）。</p>
<p>当通过共享账户使用虚拟邮箱时，这个文件就会被移动到其他地方，而目录 <code>/var/cache/courier/shared/</code> 就会被启用，但前提是你必须手动创建。</p>
<p>做完这个后，更新一下 <code>/etc/courier/imapd</code> 的内容，将 <code>IMAP_SHAREDINDEXFILE</code> 的值改为 <code>/etc/courier/shared/index</code>。</p>
<p>详见 <a href="http://www.courier-mta.org/imap/README.sharedfolders.html">http://www.courier-mta.org/imap/README.sharedfolders.html</a> 获取更多关于该设置的信息。</p>
<h3 id="cups">cups</h3>
<p><a href="https://zh.wikipedia.org/wiki/CUPS">CUPS</a>（译注：Common Unix Printing System，UNIX通用打印系统）将各种类型的状态文件存储在 <code>/etc</code> 目录下（如 <code>classes.conf</code>, <code>cupsd.conf</code>, <code>printers.conf</code> 和 <code>subscriptions.conf</code> 等），这种设定毫无改变的余地（译注：原文是 <em>and upstream is against any modification</em>，其中 <em>upstream</em> 指的应该是软件——即 CUPS——的开发组。参考：<a href="https://en.wikipedia.org/wiki/Upstream_(software_development)">Wiki: Upstream</a>）。</p>
<p>相关 bug：<a href="https://bugs.debian.org/549673">549673</a></p>
<h3 id="lvm">lvm</h3>
<p>lvm 分别在 <code>/etc/lvm/backup</code> 和 <code>/etc/lvm/archive</code> 存储文件系统中当前元数据的备份和历史元数据的归档（译注：元数据可以理解成等效于视窗操作系统下的文件属性。参考：<a href="https://www.google.com/search?q=lvm+%E5%85%83%E6%95%B0%E6%8D%AE&amp;oq=lvm+%E5%85%83%E6%95%B0%E6%8D%AE&amp;aqs=chrome..69i57.3286j0j1&amp;sourceid=chrome&amp;ie=UTF-8">google-search: lvm 元数据</a>）。这就造成任何试图更改元数据的操作（vgreduce，vgextend，lvcreate，lvremove，lvresize，等等）都会失败，这就是因为在操作过程中系统的根目录 <code>/</code> 没有挂载为读写。</p>
<p>解决方法：备份和归档的位置是在 <code>/etc/lvm/lvm.conf</code> 中指定的。所以：设置 <code>backup_dir = "/var/backups/lvm/backup"</code>，以及 <code>archive_dir = "/var/backups/lvm/archive"</code>，然后创建目录 <code>/var/backups/lvm</code> 并把 <code>/etc/lvm/backup</code> 和 <code>/etc/lvm/archive</code> 移动到这边来。</p>
<p>注意：lvm 通常会在系统启动时创建备份。但这样的事情不会再发生了，因为它很机智地意识到 <code>/var</code> 还没被挂载（或挂载成了只读）。虽然如此，但是除非你使用的是<a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/logical_volume_manager_administration/lvm_cluster_overview">集群 lvm</a>，否则 lvm 就肯定会给你做当前的备份，而这个备份，正是从你上一次对元数据做出修改开始的。所以，不会有事的。</p>
<p>相关 bug：<a href="https://bugs.debian.org/372207">372207</a>、<a href="https://bugs.debian.org/562234">562234</a> (关于 <a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/logical_volume_manager_administration/lvm_cluster_overview">etckeeper</a> 涉及到 LVM 文件的行为详见 <a href="https://bugs.debian.org/462355">462355</a>)</p>
<h3 id="mtab">mtab</h3>
<p>mount 用到这个文件。</p>
<p>解决方法：创建从 <code>/etc/mtab</code> 到 <code>/proc/self/mounts</code> 的符号连接。</p>
<p>注意，mount.cifs（从 smbfs 2:3.4.3-1 开始）会无视这个符号连接，并将其替换为一个真实的文件，详见 ~~<a href="https://bugs.debian.org/408394">408394</a>~~。</p>
<p>另外，每一个 FHS 2.3 文件系统的 <code>mtab</code> 都位于 <code>/etc</code> 底下主要是出于历史遗留的原因。</p>
<h3 id="networkrun">network/run</h3>
<p>Debian Squeeze 及以下版本的 ifupdown 会用到这个文件。</p>
<p>解决方法：利用 ifupdown 的特性，即：当 <code>/etc/network/run</code> 不是一个目录时，就将 <code>/etc/network/run</code> 链接到 <code>/run/network</code>。所以：</p>
<pre><code class="shell">rm -rf /etc/network/run
dpkg-reconfigure ifupdown
</code></pre>

<p>还可以：创建一个从 <code>/etc/network/run</code> 到 <code>/lib/init/rw/etc-network-run</code> 的符号连接（不论 <code>/var</code> 是否已经被挂载，ifupdown 的初始化脚本都会访问 <code>network/run</code>，所以我们用到了 <code>/lib/init/rw</code>，<a href="https://via.hypothes.is/https://serverfault.com/questions/30819/what-is-the-use-of-lib-init-rw-in-debian">虽然这么做有点滥用这个目录</a>）。</p>
<p>Wheezy 版本会自动使用 <code>/network/run</code>，它不会在意实际的配置存放在哪里（译注：不论配置是存放在一个符号连接里，还是存放在一个文件里）。</p>
<p>相关 bug：<a href="https://bugs.debian.org/389996">389996</a></p>
<h3 id="nologin">nologin</h3>
<p>系统启动过程中，初始化脚本 <code>bootmisc.sh</code> 和 <code>rmnologin</code> 会对该文件进行修改。</p>
<p>所以应该为它创建符号连接到 <code>/var/lib/initscripts/nologin</code>。</p>
<p>不过，Wheezy 版本直接修改的已经是 <code>/var/lib/initscripts/nologin</code> 了。</p>
<h3 id="resolvconf">resolv.conf</h3>
<p>如果你使用的是静态的域名服务器配置（译注：也就是说，不会动态更改），那么不必关注。否则的话，你就需要使用 <a href="https://packages.debian.org/search?keywords=resolvconf">resolvconf</a> 来进行动态配置。</p>
<h3 id="passwdshadow">passwd，shadow</h3>
<p>这两个文件在用户使用 chfn、chsh 和 passwd 时有可能会发生修改。如果你是这个系统的唯一用户，你可以在使用这些工具之前重新将文件系统挂载为读写模式。否则的话，你就要考虑使用 NIS 或 LDAP 了（译注：NIS——<a href="http://www.tldp.org/HOWTO/NIS-HOWTO/introduction.html">网络信息服务</a>；LDAP——<a href="https://segmentfault.com/a/1190000002607140">轻目录访问协议</a>。之所以要切换用户，为的无非是获取目标用户的资源和权限，NIS 和 LDAP 类似于实现对一些用户的资源和权限做了共享，可以通过共享的方式获取，而无需真正登录为目标用户）。</p>
<h3 id="sambadhcpconf">samba/dhcp.conf</h3>
<p>如果安装了 dhcp3-client（即众所周知的 isc-dhcp-client），那么每当建立了 DHCP 连接时， <code>/etc/dhcp3/dhclient-enter-hooks.d/samba</code> 都会创建 <code>/etc/samba/dhcp.conf</code>，不论使用与否，或者在与不在 <code>/etc/samba/smb.conf</code>。</p>
<p>相关 bug：<a href="https://bugs.debian.org/629406">629406</a>。</p>
<h3 id="suck">suck</h3>
<p><a href="http://www.linuxcertif.com/man/1/suck/">suck</a> 将文件存放在 <code>/etc/suck</code> 目录下，并在运行时修改。见 <a href="https://bugs.debian.org/206631">206631</a> 以避开此问题，简而言之你需要做的是：</p>
<ul>
<li>
<p>移动所有 <code>/etc/suck/sucknewsrc*</code> 文件到一个新的目录 <code>/var/local/suck</code>，</p>
</li>
<li>
<p>创建符号连接从 <code>/etc/suck/suckkillfile</code> 到 <code>/var/local/suck/suckkillfile</code>，</p>
</li>
<li>
<p>在 <code>get-news.conf</code> 中把 <code>etcdir</code> 设置为 <code>/var/local/suck</code> (相当于永久设置了 suck 的 <code>-dd</code> 选项)</p>
</li>
</ul>
<h3 id="udev">udev</h3>
<p>如果 udev 的规则 75-cd-aliases-generator.rules 和 75-persistent-net-generator.rules 是启用的话，udev 就会尝试修改 <code>/etc/udev/rules.d/</code> 目录下的 <code>70-persistent-cd.rules</code> 和 <code>70-persistent-net.rules</code>。所以推荐一次性把所需要的规则都创建了，然后禁用掉 <code>/etc/init.d/udev-mtab</code> 这个初始化脚本。这样，当根目录挂载为只读时，所需的规则已经被添加到 <code>/dev/udev/rules.d/</code> 目录下了。</p>
<h2 id="readonly-root">启用 readonly root</h2>
<p>要让你的根级文件系统挂载为只读，就必须在 <code>/etc/fstab</code> 中设置挂载选项为 <code>ro</code>：</p>
<pre><code class="shell"># /etc/fstab: static file system information.
#
# &lt;file system&gt;     &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;                              &lt;dump&gt;  &lt;pass&gt;
/dev/hda1           /               ext2    defaults,noatime,ro,errors=remount-ro  0       1
/dev/hda4           /var            ext3    defaults                               0       2
</code></pre>

<p>其中 <code>noatime</code> 选项很有用，特别是在硬盘被挂载为读写模式的情况下更新数据时。</p>
<h2 id="readonly-root_1">系统安装过程中启用 readonly root</h2>
<p>注：在 2010-10-20 起发布的 Debian Squeeze 版本上测试通过。</p>
<p>（略。主要是安装过程中有一些选项，可以启用 readonly root，这样就无需做上述步骤）</p>
<h2 id="_2">小贴士和小技巧</h2>
<h3 id="apt-get">在需要的时候让 apt-get 重新挂载根目录 <code>/</code></h3>
<p>要让 apt-get 在调用 dpkg 时自动重新挂载文件系统为读写，并且在 dpkg 调用结束时再将其挂载回只读，只需在 <code>/etc/apt/apt.conf</code> 中加入：</p>
<pre><code class="shell">DPkg {
    // Auto re-mounting of a readonly /
    Pre-Invoke { &quot;mount -o remount,rw /&quot;; };
    Post-Invoke { &quot;test {NO_APT_REMOUNT:-no} = yes || mount -o remount,ro / || true&quot;; };
};
</code></pre>

<p>环境变量 <code>NO_APT_REMOUNT</code> 可以被设置为 <code>yes</code>，从而禁用 apt 重新挂载文件系统为只读。这样就很灵活，特别是当你打算对所安装的软件包进行配置，或者想要在 <code>/etc</code> 目录下做些改动时。</p>
<h3 id="readonly">找出阻塞重新挂载为 readonly 的进程</h3>
<p>在更新完一轮软件包后，你可能会面临一个问题，那就是 mount 拒绝重新挂载文件系统为只读，并告诉你 “<code>/ is busy</code>”。这是由于被移除的文件被进程占用着（译注：还放在内存里）。要想找出哪些进程使用着这些已删除的文件，可以使用软件 <a href="https://packages.debian.org/debian-goodies">debian-goodies</a> 所带的工具 <a href="https://manpages.debian.org/man/1/checkrestart">checkrestart(1)</a>，或者使用如下命令。通常被找出来的进程都是些守护进程，使用着被更新的库。你必须重启这些进程才能释放这些文件。</p>
<pre><code class="shell">% {lsof +L1; lsof|sed -n '/SYSV/d; /DEL\|(path /p;'} |grep -Ev '/(dev|home|tmp|var)'
COMMAND     PID     USER   FD   TYPE DEVICE    SIZE NLINK   NODE NAME
login      1546     root    4r   REG    3,3    1331     0  66165 /etc/passwd (deleted)
startx     1587    joerg   10r   REG    3,3    4491     0 295122 /usr/bin/startx
xinit      1609    joerg  txt    REG    3,3   19084     0 295565 /usr/bin/xinit
zsh-beta   5058    joerg  txt    REG    3,3  628968     0 458849 /bin/zsh-beta
zsh-beta   5058    joerg   12r   REG    3,3  174728     0 205450 /usr/share/zsh-beta/functions/Completion.zwc
zsh-beta   5058    joerg   13r   REG    3,3 2221256     0 205405 /usr/share/zsh-beta/functions/Completion/Unix.zwc
zsh-beta   5058    joerg   14r   REG    3,3  237528     0 205398 /usr/share/zsh-beta/functions/Completion/Base.zwc
udevd       458       root  mem       REG        3,3              131417 /lib/libnss_files-2.7.so (path inode=140638)
udevd       458       root  mem       REG        3,3              131431 /lib/libnss_nis-2.7.so (path inode=140653)
udevd       458       root  mem       REG        3,3              131389 /lib/libnsl-2.7.so (path inode=140616)
udevd       458       root  mem       REG        3,3              131401 /lib/libnss_compat-2.7.so (path inode=140623)
udevd       458       root  mem       REG        3,3              131212 /lib/libdl-2.7.so (path inode=140598)
udevd       458       root  mem       REG        3,3              131159 /lib/libc-2.7.so (path inode=140581)
udevd       458       root  mem       REG        3,3              131089 /lib/ld-2.7.so (path inode=140572)
syslog-ng  1406       root  mem       REG        3,3              131417 /lib/libnss_files-2.7.so (path inode=140638)
syslog-ng  1406       root  mem       REG        3,3              131431 /lib/libnss_nis-2.7.so (path inode=140653)
syslog-ng  1406       root  mem       REG        3,3              131389 /lib/libnsl-2.7.so (path inode=140616)
syslog-ng  1406       root  mem       REG        3,3              131401 /lib/libnss_compat-2.7.so (path inode=140623)
syslog-ng  1406       root  mem       REG        3,3              131159 /lib/libc-2.7.so (path inode=140581)
syslog-ng  1406       root  mem       REG        3,3              131089 /lib/ld-2.7.so (path inode=140572)
</code></pre>

<h2 id="aufs">AUFS 方式制作只读系统</h2>
<p>你可能对<a href="https://help.ubuntu.com/community/aufsRootFileSystemOnUsbFlash">这个</a>也感兴趣。</p>
<pre><code class="python">　　
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
